<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegramå½©ç¥¨å°ç¨‹åº - æµ‹è¯•ç‰ˆ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .product-card {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 5px 0;
        }
        .button:hover {
            background: #45a049;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .balance {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å½©ç¥¨å¹³å°</h1>
            <p id="status">æ­£åœ¨åŠ è½½...</p>
        </div>

        <div id="user-info" style="display: none;">
            <h2>ç”¨æˆ·ä¿¡æ¯</h2>
            <p>ç”¨æˆ·å: <span id="username"></span></p>
            <p>ä½™é¢: $<span id="balance">0</span></p>
            <button class="button" onclick="refreshBalance()">åˆ·æ–°ä½™é¢</button>
        </div>

        <div id="products-section" style="display: none;">
            <h2>çƒ­é—¨äº§å“</h2>
            <div id="products-list"></div>
        </div>

        <div id="test-section">
            <h2>APIæµ‹è¯•</h2>
            <button class="button" onclick="testGetProducts()">æµ‹è¯•è·å–äº§å“</button>
            <button class="button" onclick="testTelegramAuth()">æµ‹è¯•Telegramè®¤è¯</button>
            <button class="button" onclick="testCreateOrder()">æµ‹è¯•åˆ›å»ºè®¢å•</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://mftfgofnosakobjfpzss.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mdGZnb2Zub3Nha29iamZwenNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDM4OTgsImV4cCI6MjA3NzYxOTg5OH0.9TYA-VqkitQayTkS4IXwOW4aqQ3aa2UKPH2IqBddbJ8';
        
        let currentUser = null;
        let currentBalance = 0;

        // åˆå§‹åŒ–Telegram WebApp
        function initTelegramApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user) {
                    document.getElementById('username').textContent = user.username || user.first_name || 'æœªçŸ¥ç”¨æˆ·';
                    document.getElementById('user-info').style.display = 'block';
                    
                    // æ¨¡æ‹Ÿè®¤è¯
                    currentUser = {
                        id: user.id,
                        username: user.username,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        language_code: user.language_code
                    };
                    
                    updateStatus('âœ… Telegram WebAppå·²åˆå§‹åŒ–', 'success');
                } else {
                    updateStatus('âš ï¸ æœªæ£€æµ‹åˆ°Telegramç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼', 'error');
                }
            } else {
                updateStatus('âš ï¸ æœªåœ¨Telegramç¯å¢ƒä¸­è¿è¡Œï¼Œä½¿ç”¨æµ‹è¯•æ¨¡å¼', 'error');
            }
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
        }

        // æµ‹è¯•è·å–äº§å“
        async function testGetProducts() {
            try {
                updateStatus('æ­£åœ¨æµ‹è¯•è·å–äº§å“API...');
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-products`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateStatus('âœ… è·å–äº§å“APIæµ‹è¯•æˆåŠŸ', 'success');
                    displayProducts(result.data.products);
                    document.getElementById('products-section').style.display = 'block';
                } else {
                    throw new Error(result.error?.message || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                updateStatus(`âŒ è·å–äº§å“APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºäº§å“åˆ—è¡¨
        function displayProducts(products) {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = '';

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-card';
                productDiv.innerHTML = `
                    <h3>${product.name.zh || product.name.en}</h3>
                    <p>ä»·æ ¼: $${product.price}</p>
                    <p>åº“å­˜: ${product.stock}</p>
                    <p>æ´»è·ƒè½®æ¬¡: ${product.active_rounds.length}</p>
                `;
                productsList.appendChild(productDiv);
            });
        }

        // æµ‹è¯•Telegramè®¤è¯
        async function testTelegramAuth() {
            try {
                updateStatus('æ­£åœ¨æµ‹è¯•Telegramè®¤è¯API...');
                
                const testUserData = {
                    telegram_id: 123456789,
                    username: 'test_user',
                    full_name: 'Test User',
                    language: 'zh',
                    photo_url: null,
                    is_premium: false
                };

                const response = await fetch(`${SUPABASE_URL}/functions/v1/telegram-auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(testUserData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateStatus('âœ… Telegramè®¤è¯APIæµ‹è¯•æˆåŠŸ', 'success');
                    if (result.data.user) {
                        currentUser = result.data.user;
                        currentBalance = result.data.user.balance || 0;
                        document.getElementById('balance').textContent = currentBalance;
                        document.getElementById('user-info').style.display = 'block';
                    }
                } else {
                    throw new Error(result.error?.message || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                updateStatus(`âŒ Telegramè®¤è¯APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•åˆ›å»ºè®¢å•
        async function testCreateOrder() {
            try {
                if (!currentUser || !currentUser.id) {
                    throw new Error('è¯·å…ˆè¿›è¡Œç”¨æˆ·è®¤è¯');
                }

                updateStatus('æ­£åœ¨æµ‹è¯•åˆ›å»ºè®¢å•API...');
                
                const orderData = {
                    user_id: currentUser.id,
                    amount: 50,
                    payment_method: 'test'
                };

                const response = await fetch(`${SUPABASE_URL}/functions/v1/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateStatus('âœ… åˆ›å»ºè®¢å•APIæµ‹è¯•æˆåŠŸ', 'success');
                    if (result.data.new_balance !== undefined) {
                        currentBalance = result.data.new_balance;
                        document.getElementById('balance').textContent = currentBalance;
                    }
                } else {
                    throw new Error(result.error?.message || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                updateStatus(`âŒ åˆ›å»ºè®¢å•APIå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°ä½™é¢
        async function refreshBalance() {
            if (currentUser && currentUser.id) {
                await testTelegramAuth();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            setTimeout(initTelegramApp, 100);
        });
    </script>
</body>
</html>