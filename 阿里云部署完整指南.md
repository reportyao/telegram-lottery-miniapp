# 阿里云部署指南 - Telegram彩票小程序

## 🚀 项目概述

Telegram彩票小程序是一个基于Next.js、Supabase和Telegram SDK的完整项目。

**当前状态:** 
- ✅ 代码已完成并经过修复
- ✅ 所有依赖已配置
- ✅ 需要部署到阿里云服务器

## 📋 服务器信息

**您的服务器:**
- 用户名: root
- 地址: iZj6c0wgvce81u5p5jgrd4Z
- 当前目录: /root/

## 🗂️ 获取项目文件的方法

### 方法1: 通过SCP直接传输（推荐）

```bash
# 在您的阿里云服务器上执行
scp -r /path/to/project-files/* root@iZj6c0wgvce81u5p5jgrd4Z:/root/telegram-lottery-miniapp/
```

### 方法2: 通过GitHub（推荐）

```bash
# 在您的服务器上
cd /root
git clone [您的GitHub仓库地址] telegram-lottery-miniapp
cd telegram-lottery-miniapp
```

### 方法3: 通过在线文件共享

1. 将项目文件打包为zip
2. 上传到在线文件共享服务（如腾讯云盘、阿里云盘、百度网盘）
3. 在服务器上下载并解压

### 方法4: 通过wget直接下载

如果我有GitHub仓库地址，您可以通过：
```bash
wget [GitHub raw文件地址] -O telegram-lottery-miniapp.zip
unzip telegram-lottery-miniapp.zip
```

## 🔧 部署步骤

### 第1步: 获取项目文件

选择上述任一方法获取项目文件，确保项目文件在 `/root/telegram-lottery-miniapp/` 目录中。

### 第2步: 安装依赖

```bash
cd /root/telegram-lottery-miniapp

# 使用淘宝镜像源避免网络问题
npm config set registry https://registry.npm.taobao.org

# 安装依赖
npm install
```

### 第3步: 配置环境变量

创建 `.env.local` 文件：

```bash
cat > .env.local << 'EOF'
# Supabase配置
NEXT_PUBLIC_SUPABASE_URL=您的Supabase项目URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=您的Supabase匿名密钥

# Telegram Bot配置（可选）
NEXT_PUBLIC_TELEGRAM_BOT_TOKEN=您的Telegram Bot Token

# 应用配置
NODE_ENV=production
PORT=3000
EOF
```

### 第4步: 构建和启动

```bash
# 构建项目
npm run build

# 启动应用
npm start
```

### 第5步: 使用PM2管理进程

```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start npm --name "telegram-lottery" -- start

# 设置开机自启
pm2 startup
pm2 save
```

### 第6步: 配置Nginx（可选）

```bash
# 安装Nginx
apt update
apt install nginx -y

# 配置反向代理
cat > /etc/nginx/sites-available/telegram-lottery << 'EOF'
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# 启用站点
ln -s /etc/nginx/sites-available/telegram-lottery /etc/nginx/sites-enabled/
systemctl reload nginx
```

## 🔍 故障排除

### 问题1: npm install 失败

```bash
# 清理缓存
npm cache clean --force
rm -rf node_modules package-lock.json

# 使用不同镜像源
npm config set registry https://registry.npm.taobao.org
npm install
```

### 问题2: 端口被占用

```bash
# 查看端口占用
netstat -tulnp | grep 3000

# 结束占用进程
kill -9 [PID]
```

### 问题3: 构建失败

```bash
# 检查TypeScript错误
npm run type-check

# 检查依赖版本兼容性
npm audit
```

## 📝 部署检查清单

- [ ] 项目文件已正确传输
- [ ] Node.js版本 >= 18
- [ ] npm install 成功执行
- [ ] .env.local 文件已创建并配置
- [ ] npm run build 成功
- [ ] npm start 成功启动
- [ ] 端口3000可正常访问
- [ ] PM2进程管理器已配置
- [ ] Nginx反向代理已配置（可选）

## 🌐 访问应用

部署成功后，您可以通过以下方式访问应用：

1. **直接访问:** `http://iZj6c0wgvce81u5p5jgrd4Z:3000`
2. **通过域名:** `http://your-domain.com`

## 📞 需要帮助？

如果遇到任何问题，请提供：

1. 具体的错误信息
2. 操作系统版本
3. Node.js版本 (`node --version`)
4. npm版本 (`npm --version`)

我将协助您解决部署问题。

---

**项目特点:**
- ✅ 完整的Telegram彩票系统
- ✅ 用户管理和身份验证
- ✅ 产品展示和购买
- ✅ 彩票抽奖功能
- ✅ 转售市场
- ✅ 管理后台
- ✅ 响应式设计

**技术栈:**
- Next.js 14 (React框架)
- Supabase (数据库和认证)
- Telegram SDK (Telegram集成)
- TypeScript (类型安全)
- Tailwind CSS (样式)
- Jest (测试)